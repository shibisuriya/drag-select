<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      * {
        outline: 1px dotted black !important;
      }
      body {
        margin: 0px;
        position: relative;
      }
      .image {
        width: 500px;
        height: 500px;
        background-color: red;
        color: black;
        position: absolute;
        left: 100px;
        top: 100px;
      }
    </style>
    <script>
      const LEFT_MOUSE = 1;
      let dragSelectElement = null;
      let abortController = null;
      let anchorPoint = {};
      function getScrollInfo() {
        return {
          scrollX: window.scrollX,
          scrollY: window.scrollY,
        };
      }
      function getElementPosition(el) {
        const { scrollX, scrollY } = getScrollInfo();
        const { left, top, width, height } = el.getBoundingClientRect();
        return {
          x: left + scrollX,
          y: top + scrollY,
          width: width,
          height: height,
        };
      }
      function getElementDimension(el) {
        const { width, height } = el.getBoundingClientRect();
        return {
          width: width,
          height: height,
        };
      }
      function getContainerElement(containerClass = "image") {
        const [imageElement] = document.getElementsByClassName(containerClass);
        return imageElement;
      }
      function mouseDown() {
        const { which: buttonName, offsetY, offsetX } = event;
        if (buttonName == LEFT_MOUSE) {
          // Subscribe to `mouseMove` event on `document` here.
          abortController = new AbortController();
          document.addEventListener("mousemove", mouseMove, {
            signal: abortController.signal,
          });
          document.addEventListener("mouseup", mouseUpAnywhere, {
            signal: abortController.signal,
          });
          const containerElement = getContainerElement();
          dragSelectElement = document.createElement("div");
          dragSelectElement.style.position = "absolute";
          dragSelectElement.style.top = `${offsetY}px`;
          dragSelectElement.style.left = `${offsetX}px`;
          dragSelectElement.style.border = "5px solid black";
          dragSelectElement.style.boxSizing = "border-box";
          anchorPoint = { x: offsetX, y: offsetY };
          containerElement.appendChild(dragSelectElement);
        }
      }
      function mouseUpAnywhere() {
        const { which: buttonName } = event;
        if (buttonName == LEFT_MOUSE) {
          // Unsubscribe to `mouseMove` event on `document` here.
          abortController.abort();
          abortController = null;
          dragSelectElement = null;
          anchorPoint = {};
        }
      }
      function mouseMove() {
        if (dragSelectElement) {
          const { pageX, pageY } = event; // Position of the mouse pointer in the page (scroll lengths included).
          const containerElement = getContainerElement();
          const containerElementPosition = getElementPosition(containerElement);
          const containerElementDimension =
            getElementDimension(containerElement);
          const left = pageX - containerElementPosition.x;
          const top = pageY - containerElementPosition.y;
          const { x: anchorX, y: anchorY } = anchorPoint;
          if (left <= containerElementDimension.width && left >= 0) {
            // Mouse pointer is inside the container element.
            if (left - anchorX >= 0) {
              dragSelectElement.style.left = `${anchorX}px`;
              dragSelectElement.style.width = `${left - anchorX}px`;
            } else {
              dragSelectElement.style.left = `${left}px`;
              dragSelectElement.style.width = `${anchorX - left}px`;
            }
          } else if (left > containerElementDimension.width) {
            // Mouse pointer is to the right of the container element.
            dragSelectElement.style.width = `${
              containerElementDimension.width - anchorX
            }px`;
          } else if (left < 0) {
            // Mouse pointer is to the left of the container element.
            dragSelectElement.style.left = "0px";
            dragSelectElement.style.width = `${anchorX}px`;
          }
          if (top <= containerElementDimension.height && top >= 0) {
            // Mouse pointer is inside the container element.
            if (top - anchorY >= 0) {
              dragSelectElement.style.top = `${anchorY}px`;
              dragSelectElement.style.height = `${top - anchorY}px`;
            } else {
              dragSelectElement.style.top = `${top}px`;
              dragSelectElement.style.height = `${anchorY - top}px`;
            }
          } else if (top > containerElementDimension.height) {
            // Mouse pointer is below the container element.
            dragSelectElement.style.height = `${
              containerElementDimension.height - anchorY
            }px`;
          } else if (top < 0) {
            // Mouse pointer is above the container element.
            dragSelectElement.style.top = "0px";
            dragSelectElement.style.height = `${anchorY}px`;
          }
        }
      }
    </script>
  </head>
  <body>
    <div class="image" onmousedown="mouseDown()"></div>
  </body>
</html>
